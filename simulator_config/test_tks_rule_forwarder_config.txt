# Simulator rule definition file for ITK Testbench
#  GP Connect Messages
#
BEGIN RESPONSES
INCLUDE /mnt/encrypted/home/simonfarrow/Documents/TKW5.0Dev/TKW/config/GP_CONNECT/simulator_config/gpconnect_common_responses.conf
do_process	NONE	0
patient2_diary_response /mnt/encrypted/home/simonfarrow/Documents/TKW5.0Dev/TKW/config/GP_CONNECT/simulator_config/responses/diary_response.xml "200 OK"
patient2_document_reference_response /mnt/encrypted/home/simonfarrow/Documents/TKW5.0Dev/TKW/config/GP_CONNECT/simulator_config/responses/document_reference_response.xml "200 OK"
patient2_document_response /mnt/encrypted/home/simonfarrow/Documents/TKW5.0Dev/TKW/config/GP_CONNECT/simulator_config/responses/document_response.xml "200 OK"
documents_metadata_response /mnt/encrypted/home/simonfarrow/Documents/TKW5.0Dev/TKW/config/GP_CONNECT/simulator_config/responses/documents_capability.xml "200 OK"
END RESPONSES

BEGIN SUBSTITUTIONS
__MESSAGEID__	UUID
__TIMESTAMP__	ISO8601datetime
__JOBID__	UUID
__ERRORID__	UUID
__ERRORCODE__ Literal INVALID_PARAMETER
__ERRORTEXT_IVP__ Xpath concat('Disallowed Parameter part type combination for ',if (//fhir:parameter/fhir:name[@value='includeConsultations']) then 'Consultations ' else 'Problems ',string-join(/fhir:Parameters/fhir:parameter/fhir:part/fhir:name[@value=('medicationSearchFromDate','uncategorisedDataSearchPeriod') or (//fhir:parameter/fhir:name[@value='includeConsultations'] and (@value=('filterSignificance','filterStatus'))) or @value=('referralSearchPeriod','diaryEntriesSearchDate','includeNotGiven','includeDissentConsent')]/concat(../../fhir:name/@value,'.',@value),','))
__SERVER__ Literal NHS Digital TKW Server
__PATIENT_1__ Literal 9658218865
__PATIENT_2__ Literal 9658218873

__PATIENT_ID__ Xpath /fhir:Parameters/fhir:parameter[fhir:name/@value='patientNHSNumber']/fhir:valueIdentifier/fhir:value/@value
__PRACTITIONER_ID__ Literal 1
__PATIENT_LOGICAL_ID__ reg_exp context_path  "^.*Patient/([^/]+)/.*$" "$1"
__PATIENT_2_LOGICAL_ID__ Literal 2
__ERRORTEXT_CE__ Xpath (if (//fhirconversionfailure) then concat('Failed to parse request body. Error was: ',replace(/fhirconversionfailure,'"','&quot;')) else '')
__SSP_TO__ reg_exp http_header Ssp-to "^(.*)$" "$1"
#SESSION_ID reg_exp http_header Ssp-from "^(.*)$" "$1"

# patient specific preamble added to the start of a structured response
__PATIENT_HEAD__ Xpath ( if (fhir:Parameters/fhir:parameter[fhir:name/@value='includeDiaryEntries']) then doc(concat('/mnt/encrypted/home/simonfarrow/Documents/TKW5.0Dev/TKW/config/GP_CONNECT/simulator_config/responses/',/fhir:Parameters/fhir:parameter[fhir:name/@value='patientNHSNumber']/fhir:valueIdentifier/fhir:value/@value,'_head.xml'))/block/text() else '' )
__PATIENT_2_HEAD__ Xpath doc('/mnt/encrypted/home/simonfarrow/Documents/TKW5.0Dev/TKW/config/GP_CONNECT/simulator_config/responses/9658218873_head.xml')/block/text()

# parameter part check
# one operation outcome with a separate issue for each unrecognised parameter part
__DIARY_ENTRIES_WARNINGS__ Xpath (if (count (fhir:Parameters/fhir:parameter[fhir:name/@value='includeDiaryEntries']/fhir:part[fhir:name/@value!='diaryEntriesSearchDate']) > 0) then concat('<entry><resource><OperationOutcome><meta><profile value="https://fhir.nhs.uk/StructureDefinition/gpconnect-operationoutcome-1"/></meta>',string-join(for $r in /fhir:Parameters/fhir:parameter[fhir:name/@value='includeDiaryEntries']/fhir:part[fhir:name/@value!='diaryEntriesSearchDate']/fhir:name/@value return replace(doc('/mnt/encrypted/home/simonfarrow/Documents/TKW5.0Dev/TKW/config/GP_CONNECT/simulator_config/responses/warning.xml')/block/text(),'__CLINICAL_AREA__',$r),''),'</OperationOutcome></resource></entry>') else '')

__DOCREF_ID__ Literal 27863182736
__BINARY_URL__ Property /mnt/encrypted/home/simonfarrow/Documents/TKW5.0Dev/TKW/config/GP_CONNECT/internal/gpconnect-demonstrator-api.properties /mnt/encrypted/home/simonfarrow/Documents/TKW5.0Dev/TKW/config/GP_CONNECT/internal/gpconnect-demonstrator-api.environment.properties /mnt/encrypted/home/simonfarrow/Documents/TKW5.0Dev/TKW/config/GP_CONNECT/external/gpconnect-demonstrator-api.environment.properties serverBaseUrl

__BAD_DOC_SEARCH_PARM__ reg_exp context_path "^[^?]+\?.*?^(_include|_revinclude%3Arecurse|author|facility|created|type|description)=[^&]+(&|$).*" "$1"

END SUBSTITUTIONS

# all the "match/contains" rules apply to the content by default to use eg the context path it must be specified as context_path
BEGIN EXPRESSIONS
INCLUDE /mnt/encrypted/home/simonfarrow/Documents/TKW5.0Dev/TKW/config/GP_CONNECT/simulator_config/fhir_expressions_common.conf
passthrough	Always
dontpassthrough	Never
single_clinical_area xpathequals count(/fhir:Parameters/fhir:parameter) 2
multiple_clinical_areas xpathequals count(/fhir:Parameters/fhir:parameter)>2  true

# diary entries
single_diary_entry xpathequals count(/fhir:Parameters/fhir:parameter[fhir:name/@value='includeDiaryEntries']) 1
diary_entries xpathequals count(/fhir:Parameters/fhir:parameter[fhir:name/@value='includeDiaryEntries'])>0 true

QUERY_PATIENT_2 xpathequals /fhir:Parameters/fhir:parameter[fhir:name/@value='patientNHSNumber']/fhir:valueIdentifier/fhir:value/@value 9658218873
GET_PATIENT_2 context_path matches ^.*/Patient/2/.*$

# GetBinary
GET_PATIENT_2_DOCUMENT context_path matches ^.*/Binary/07a6483f-732b-461e-86b6-edb665c45510$

# search document references

DOCUMENT_SEARCH_PARAMETERS_VALID context_path matches ^[^?]+\?((_include|_revinclude%3Arecurse|author|facility|created|type|description)=[^&]+(&|$))+

SEARCH_INCLUDES_MANDATORY_PATIENT context_path matches ^.*_include=DocumentReference%3Asubject%3APatient.*$
SEARCH_INCLUDES_MANDATORY_CUSTODIAN context_path matches ^.*_include=DocumentReference%3Acustodian%3AOrganization.*$
SEARCH_INCLUDES_MANDATORY_AUTHOR_ORG context_path matches ^.*_include=DocumentReference%3Aauthor%3AOrganization.*$
SEARCH_INCLUDES_MANDATORY_AUTHOR_PRAC context_path matches ^.*_include=DocumentReference%3Aauthor%3APractitioner.*$
SEARCH_INCLUDES_MANDATORY_PRAC_ROLE context_path matches ^.*_revinclude%3Arecurse=PractitionerRole%3Apractitioner.*$

FACILITY_SEARCH context_path matches ^.*facility=.*$
FACILITY_SYSTEM_VALID context_path matches ^.*facility=https%3A%2F%2Ffhir.nhs.uk%2FId%2Fods-organization-code%7[Cc].*$

AUTHOR_SEARCH context_path matches ^.*author=.*$
AUTHOR_SYSTEM_VALID context_path matches ^.*author=https%3A%2F%2Ffhir.nhs.uk%2FId%2Fods-organization-code%7[Cc].*$

# 0..2 created parameters
CREATED_MORE_THAN_2 context_path matches ^.*(created=.+){3,}.*$
CREATED_2 context_path matches ^.*(created=.+){2}.*$
CREATED context_path matches ^.*(created=.+).*$
#                                                     YYYY -  M   M  -  D    D   T  H    H  :  M    M  :  S    S    .ssss      +00   :00
CREATED_GE_VALID context_path matches ^.*created=ge[0-9]{4}-[01][0-9]-[0-3][0-9](T[0-2][0-9]%3A[0-5][0-9]%3A[0-5][0-9](\.[0-9]+)?(%2B0[01]%3A00)?)?(\&.+)?$
CREATED_LE_VALID context_path matches ^.*created=le[0-9]{4}-[01][0-9]-[0-3][0-9](T[0-2][0-9]%3A[0-5][0-9]%3A[0-5][0-9](\.[0-9]+)?(%2B0[01]%3A00)?)?(\&.+)?$
#
# le later than ge ?
CREATED_RANGE_VALID Class uk.nhs.digital.mait.tkwx.tk.internalservices.rules.FhirDateCompareExpression context_path "^.*created=ge([0-9]{4}-[01][0-9]-[0-3][0-9](T[0-2][0-9]%3A[0-5][0-9]%3A[0-5][0-9](\.[0-9]+)?(%2B0[01]%3A00)?)?)(\&.+)?$" "$1" context_path "^.*created=le([0-9]{4}-[01][0-9]-[0-3][0-9](T[0-2][0-9]%3A[0-5][0-9]%3A[0-5][0-9](\.[0-9]+)?(%2B0[01]%3A00)?)?)(\&.+)?$" "$1"  "<="

# other clinical areas
consultationsRequested xpathequals count(/fhir:Parameters/fhir:parameter[fhir:name/@value='includeConsultations'])>0 true
problemsRequested xpathequals count(/fhir:Parameters/fhir:parameter[fhir:name/@value='includeProblems'])>0 true

invalidPartParametersForConsultations xpathequals count(/fhir:Parameters/fhir:parameter/fhir:part/fhir:name[@value=('medicationSearchFromDate','uncategorisedDataSearchPeriod','filterSignificance','filterStatus','referralSearchPeriod','diaryEntriesSearchDate','includeNotGiven','includeDissentConsent')])>0 true
invalidPartParametersForProblems xpathequals count(/fhir:Parameters/fhir:parameter/fhir:part/fhir:name[@value=('medicationSearchFromDate','uncategorisedDataSearchPeriod','referralSearchPeriod','diaryEntriesSearchDate','includeNotGiven','includeDissentConsent')])>0 true

# diary entries
multiple_search_date_parameters  xpathequals count(/fhir:Parameters/fhir:parameter[fhir:name/@value='includeDiaryEntries']/fhir:part[fhir:name/@value='diaryEntriesSearchDate'])>1 true
single_search_date_parameter  xpathequals count(/fhir:Parameters/fhir:parameter[fhir:name/@value='includeDiaryEntries']/fhir:part[fhir:name/@value='diaryEntriesSearchDate'])=1 true
search_date_parameter_well_formed xpathmatches /fhir:Parameters/fhir:parameter[fhir:name/@value='includeDiaryEntries']/fhir:part[fhir:name/@value='diaryEntriesSearchDate']/fhir:valueDate/@value ^[0-9]{4}-[0-9]{2}-[0-9]{2}$

END EXPRESSIONS

#
#  Rules
#

#==================================================================================================
#  Structured Data - Diary Entries Clinical Area
#

BEGIN RULE
POST+urn:nhs:names:services:gpconnect:fhir:operation:gpc.getstructuredrecord-1
INCLUDE 	/mnt/encrypted/home/simonfarrow/Documents/TKW5.0Dev/TKW/config/GP_CONNECT/simulator_config/fhir_rules_common.conf
#
#    Http header checks
#
if not EMPTY_ACCEPT and INVALID_ACCEPT then operation_outcome_415
if INVALID_CONTENT_TYPE then operation_outcome_415
if EMPTY_CONTENT then operation_outcome_400
#
if NO_PARAMETERS then operation_outcome_422_ivr
# Order of tests is important no point in checking parameters if content-type is wrong and its actually valid json because conversion to xml won't happen.
#
#  NHS Number checks
#
if INVALID_NHS_NO_SYSTEM_ID then operation_outcome_422_iis
if INVALID_NHS_NUMBER then operation_outcome_400_ivnnn
if NO_NHS_NO_SYSTEM_ID or EMPTY_NHS_NO_SYSTEM_ID then operation_outcome_422
#
if JWT_PAYLOAD_PATIENT_MISMATCH then operation_outcome_400
if not JWT_PAYLOAD_REQUESTED_SCOPE_PATIENT then operation_outcome_400
#
if not GETSTRUCTUREDRECORD_CP then operation_outcome_404
# needs to be check before any further references to the NNN
if PATIENT_COUNT_INVALID then operation_outcome_400

if consultationsRequested and invalidPartParametersForConsultations then  operation_outcome_422_ivp
if problemsRequested and invalidPartParametersForProblems then  operation_outcome_422_ivp

if multiple_clinical_areas and diary_entries then operation_outcome_400_multiple_clinical_areas

# 0..1 search dates of the form YYYY-MM-DD
if multiple_search_date_parameters then operation_outcome_422_diary_entries_multiple_search_dates
if single_search_date_parameter and not search_date_parameter_well_formed then operation_outcome_422_diary_entries_invalid_search_date

if QUERY_PATIENT_2 and single_clinical_area and single_diary_entry then patient2_diary_response

if single_clinical_area and single_diary_entry then patient_not_found_response
END RULE

#==================================================================================================
# Documents Interface - Search Document Reference
#

BEGIN RULE
GET+urn:nhs:names:services:gpconnect:documents:fhir:rest:search:documentreference-1
INCLUDE /mnt/encrypted/home/simonfarrow/Documents/TKW5.0Dev/TKW/config/GP_CONNECT/simulator_config/fhir_rules_common.conf

if not DOCUMENT_SEARCH_PARAMETERS_VALID then operation_outcome_422_document_search_invalid_parameters

# includes checks
if not SEARCH_INCLUDES_MANDATORY_PATIENT then operation_outcome_422_document_search_missing_mandatory_patient
if not SEARCH_INCLUDES_MANDATORY_CUSTODIAN then operation_outcome_422_document_search_missing_mandatory_custodian
if not SEARCH_INCLUDES_MANDATORY_AUTHOR_ORG then operation_outcome_422_document_search_missing_mandatory_author_org
if not SEARCH_INCLUDES_MANDATORY_AUTHOR_PRAC then operation_outcome_422_document_search_missing_mandatory_author_prac
if not SEARCH_INCLUDES_MANDATORY_PRAC_ROLE then operation_outcome_422_document_search_missing_mandatory_prac_role

# search checks
if FACILITY_SEARCH and not FACILITY_SYSTEM_VALID then operation_outcome_422_document_search_facility_invalid_system
if AUTHOR_SEARCH and not AUTHOR_SYSTEM_VALID then operation_outcome_422_document_search_author_invalid_system

# created checks
if CREATED_MORE_THAN_2 then operation_outcome_422_document_search_created_more_than_2
if CREATED_2 and not CREATED_GE_VALID then operation_outcome_422_document_search_no_created_ge
if CREATED_2 and not CREATED_LE_VALID then operation_outcome_422_document_search_no_created_le
if CREATED and not ( CREATED_LE_VALID or CREATED_GE_VALID ) then operation_outcome_422_document_search_no_created_le_or_ge
# invalid date range?

if CREATED_2 and not CREATED_RANGE_VALID then operation_outcome_422_document_search_created_ge_after_le

if GET_PATIENT_2 then patient2_document_reference_response else patient_not_found_response
END RULE

#==================================================================================================
# Documents Interface - Read Binary
#

BEGIN RULE
GET+urn:nhs:names:services:gpconnect:documents:fhir:rest:read:binary-1
INCLUDE /mnt/encrypted/home/simonfarrow/Documents/TKW5.0Dev/TKW/config/GP_CONNECT/simulator_config/fhir_rules_common.conf
if GET_PATIENT_2_DOCUMENT then patient2_document_response else binary_nrf
END RULE

#==================================================================================================
# Documents Interface - Read Metadata
#

BEGIN RULE
GET+urn:nhs:names:services:gpconnect:documents:fhir:rest:read:metadata-1
INCLUDE /mnt/encrypted/home/simonfarrow/Documents/TKW5.0Dev/TKW/config/GP_CONNECT/simulator_config/fhir_rules_common.conf
if passthrough then documents_metadata_response
END RULE

#==================================================================================================
# default forwarding rules to demonstrator
#

# these idiomatic rules ensure forwarding to the endpoint since no rule is invoked
BEGIN RULE
GET
if dontpassthrough then do_process
END RULE

BEGIN RULE
POST
if dontpassthrough then do_process
END RULE

BEGIN RULE
PUT
if dontpassthrough then do_process
END RULE

BEGIN RULE
DELETE
if dontpassthrough then do_process
END RULE

BEGIN RULE
PATCH
if dontpassthrough then do_process
END RULE

BEGIN RULE
OPTIONS
if dontpassthrough then do_process
END RULE
#=========================================================================================
